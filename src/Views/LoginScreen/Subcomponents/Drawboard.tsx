import React, { useState } from "react";
import { View, StyleSheet } from "react-native";
import {
  Gesture,
  GestureDetector,
  GestureHandlerRootView,
} from "react-native-gesture-handler";
import { Canvas, Path } from "@shopify/react-native-skia";

import { useNavigation } from "@react-navigation/native";
import Toast from "react-native-toast-message";
import { useColorContext } from "../../../StateManagement/ColorContext/ColorContext";
interface IPath {
  segments: String[];
  color?: string;
}

export default function Drawboard() {
  const palette = useColorContext().state;
  const stylesWithPalette = styles(palette);
  const placeHolderPath = {
    color: palette.main,
    segments: [
      "M 191.18382263183594 411.2314453125",
      "L 191.18382263183594 411.2314453125",
      "L 188.38783264160156 411.2314453125",
      "L 187.17584228515625 411.2314453125",
      "L 184.62249755859375 411.2314453125",
      "L 183.34686279296875 411.8808288574219",
      "L 181.2282257080078 412.3447265625",
      "L 176.1747589111328 412.3447265625",
      "L 171.8378448486328 414.52069091796875",
      "L 166.23558044433594 414.8665771484375",
      "L 160.59320068359375 415.2544250488281",
      "L 157.08563232421875 415.2544250488281",
      "L 148.7870635986328 415.2544250488281",
      "L 142.19192504882812 415.2544250488281",
      "L 137.09915161132812 415.2544250488281",
      "L 131.91612243652344 413.6033935546875",
      "L 128.27716064453125 412.3447265625",
      "L 124.74331665039062 410.89923095703125",
      "L 120.57201385498047 408.5434265136719",
      "L 117.3240966796875 406.09149169921875",
      "L 111.68645477294922 402.9161071777344",
      "L 107.9576416015625 399.2147216796875",
      "L 100.5500717163086 393.3273620605469",
      "L 98.19676971435547 389.8381042480469",
      "L 93.74951934814453 386.0823974609375",
      "L 89.30805969238281 380.55584716796875",
      "L 86.58274841308594 376.1112365722656",
      "L 83.03390502929688 371.7015380859375",
      "L 79.15860748291016 362.57208251953125",
      "L 76.74441528320312 355.72021484375",
      "L 75.62588500976562 349.7370910644531",
      "L 74.08529663085938 346.1372985839844",
      "L 73.4446029663086 341.4943542480469",
      "L 73.4446029663086 337.2118835449219",
      "L 73.4446029663086 331.0150146484375",
      "L 74.53524780273438 325.4568176269531",
      "L 76.19914245605469 319.5577392578125",
      "L 78.62372589111328 313.98663330078125",
      "L 82.16849517822266 307.2441711425781",
      "L 85.65343475341797 300.9460754394531",
      "L 90.9055404663086 294.14471435546875",
      "L 94.72943878173828 289.0916748046875",
      "L 98.58831024169922 285.7001647949219",
      "L 104.04309844970703 282.8570556640625",
      "L 106.81804656982422 281.4668884277344",
      "L 111.62908172607422 279.0672607421875",
      "L 114.04582977294922 279.6112365722656",
      "L 117.69074249267578 279.6112365722656",
      "L 122.66824340820312 279.6112365722656",
      "L 125.90510559082031 279.6112365722656",
      "L 130.71971130371094 279.6112365722656",
      "L 134.10548400878906 280.4862060546875",
      "L 136.69015502929688 280.69921875",
      "L 138.89515686035156 283.18865966796875",
      "L 140.5054168701172 284.4935607910156",
      "L 142.16708374023438 286.9022216796875",
      "L 143.98574829101562 290.1570129394531",
      "L 145.307861328125 292.56591796875",
      "L 147.69659423828125 297.4179992675781",
      "L 148.98883056640625 300.88623046875",
      "L 150.33250427246094 303.7772521972656",
      "L 150.5326690673828 307.3171691894531",
      "L 151.62330627441406 311.5127258300781",
      "L 151.62330627441406 315.0367431640625",
      "L 152.71995544433594 319.9803466796875",
      "L 153.37860107421875 323.7665100097656",
      "L 153.44505310058594 327.3600769042969",
      "L 153.44505310058594 331.46368408203125",
      "L 153.44505310058594 335.1709289550781",
      "L 153.44505310058594 338.2343444824219",
      "L 153.44505310058594 340.1459045410156",
      "L 153.44505310058594 341.3612060546875",
      "L 153.44505310058594 342.3218688964844",
      "L 153.44505310058594 338.5741271972656",
      "L 153.44505310058594 336.55828857421875",
      "L 153.44505310058594 332.5932312011719",
      "L 153.44505310058594 328.8451232910156",
      "L 153.44505310058594 325.2613525390625",
      "L 152.35440063476562 321.66192626953125",
      "L 152.1570281982422 318.0336608886719",
      "L 151.07513427734375 313.42138671875",
      "L 149.44203186035156 307.8140869140625",
      "L 149.44203186035156 304.1206970214844",
      "L 149.44203186035156 299.03875732421875",
      "L 148.99322509765625 294.0663146972656",
      "L 148.35137939453125 288.37042236328125",
      "L 148.35137939453125 282.41192626953125",
      "L 147.2607421875 277.6603698730469",
      "L 147.2607421875 271.7968444824219",
      "L 147.2607421875 266.1363525390625",
      "L 147.2607421875 261.04083251953125",
      "L 147.2607421875 255.80738830566406",
      "L 147.2607421875 250.0166473388672",
      "L 147.2607421875 242.70156860351562",
      "L 147.2607421875 236.88999938964844",
      "L 148.10157775878906 230.35333251953125",
      "L 148.35137939453125 223.74330139160156",
      "L 149.44203186035156 217.9919891357422",
      "L 149.44203186035156 211.43316650390625",
      "L 150.25022888183594 205.635498046875",
      "L 151.512451171875 200.20751953125",
      "L 152.35440063476562 195.04408264160156",
      "L 152.35440063476562 189.39390563964844",
      "L 154.08932495117188 183.77284240722656",
      "L 154.5356903076172 177.96600341796875",
      "L 155.62632751464844 172.65615844726562",
      "L 158.12266540527344 164.54354858398438",
      "L 159.65789794921875 161.7324676513672",
      "L 162.70953369140625 152.372314453125",
      "L 164.94314575195312 146.58651733398438",
      "L 167.45205688476562 141.66949462890625",
      "L 171.22479248046875 138.0593719482422",
      "L 174.80955505371094 134.4814453125",
      "L 177.49288940429688 132.25486755371094",
      "L 181.1633758544922 130.49249267578125",
      "L 183.08535766601562 129.15283203125",
      "L 186.13990783691406 128.3314971923828",
      "L 189.10394287109375 128.3314971923828",
      "L 191.5512237548828 128.3314971923828",
      "L 194.695068359375 128.3314971923828",
      "L 197.14291381835938 128.3314971923828",
      "L 199.5292510986328 128.3314971923828",
      "L 202.73724365234375 129.20375061035156",
      "L 206.25779724121094 131.71087646484375",
      "L 209.908935546875 133.95465087890625",
      "L 214.50657653808594 137.23719787597656",
      "L 219.70108032226562 140.60084533691406",
      "L 224.97103881835938 144.99041748046875",
      "L 230.75953674316406 149.56846618652344",
      "L 235.36866760253906 154.06520080566406",
      "L 240.79954528808594 158.6057586669922",
      "L 245.9413604736328 163.5937957763672",
      "L 250.633544921875 168.43080139160156",
      "L 255.40562438964844 174.01031494140625",
      "L 261.0537414550781 181.03736877441406",
      "L 264.4635314941406 185.85987854003906",
      "L 268.076416015625 192.11996459960938",
      "L 270.8030090332031 197.35946655273438",
      "L 273.4397277832031 204.52256774902344",
      "L 275.150390625 211.07810974121094",
      "L 276.7116394042969 217.81256103515625",
      "L 277.8022766113281 225.13462829589844",
      "L 279.1427917480469 230.69375610351562",
      "L 279.98358154296875 235.54722595214844",
      "L 279.98358154296875 240.91734313964844",
      "L 279.98358154296875 247.96954345703125",
      "L 279.98358154296875 253.97962951660156",
      "L 278.8929443359375 259.5738220214844",
      "L 277.1840515136719 265.2081298828125",
      "L 275.8631896972656 269.7437744140625",
      "L 274.5303649902344 275.5575866699219",
      "L 271.33758544921875 279.3458251953125",
      "L 268.9021301269531 285.0420227050781",
      "L 265.4109191894531 290.0155334472656",
      "L 262.8928527832031 293.2820129394531",
      "L 259.8294677734375 297.9574279785156",
      "L 255.926025390625 301.1033020019531",
      "L 251.9272003173828 304.6104736328125",
      "L 247.72300720214844 308.1000671386719",
      "L 245.0637664794922 310.16973876953125",
      "L 241.95826721191406 311.2385559082031",
      "L 239.4963836669922 313.9315490722656",
      "L 237.02125549316406 315.6157531738281",
      "L 234.59925842285156 316.6407470703125",
      "L 233.44549560546875 317.9616394042969",
      "L 231.11094665527344 318.2927551269531",
      "L 228.7920379638672 319.3939208984375",
      "L 227.37193298339844 320.5909423828125",
      "L 225.01580810546875 321.7894287109375",
      "L 224.84637451171875 322.8774108886719",
      "L 223.25672912597656 323.6081237792969",
      "L 221.80198669433594 323.9653625488281",
      "L 220.64779663085938 323.9653625488281",
      "L 221.07688903808594 325.59735107421875",
      "L 219.98623657226562 325.0533447265625",
      "L 217.77304077148438 326.1666259765625",
      "L 216.52569580078125 326.1666259765625",
      "L 216.7143096923828 327.57635498046875",
      "L 215.62367248535156 327.2546081542969",
      "L 213.4423828125 327.96307373046875",
      "L 211.91285705566406 329.0510559082031",
      "L 210.62232971191406 330.0700988769531",
      "L 208.34872436523438 331.44677734375",
      "L 207.09405517578125 332.50390625",
      "L 205.24252319335938 333.2629699707031",
      "L 204.53147888183594 333.9722595214844",
      "L 206.82411193847656 331.2523193359375",
      "L 209.22280883789062 328.1791076660156",
      "L 213.42185974121094 325.0781555175781",
      "L 215.94227600097656 323.6475524902344",
      "L 221.07688903808594 320.1574401855469",
      "L 223.66123962402344 318.85272216796875",
      "L 228.21763610839844 317.7917175292969",
      "L 232.76429748535156 316.4591979980469",
      "L 237.66758728027344 316.7037353515625",
      "L 243.2612762451172 315.6157531738281",
      "L 246.85580444335938 315.6157531738281",
      "L 251.6855926513672 314.5278015136719",
      "L 257.02203369140625 314.5278015136719",
      "L 261.4129943847656 314.5278015136719",
      "L 265.82977294921875 314.5278015136719",
      "L 269.3656921386719 315.6157531738281",
      "L 272.4730529785156 315.6157531738281",
      "L 274.96612548828125 316.7037353515625",
      "L 276.9442443847656 317.7917175292969",
      "L 280.8310852050781 317.7917175292969",
      "L 284.0563049316406 319.6830139160156",
      "L 287.5545349121094 320.9967041015625",
      "L 290.520751953125 322.3285827636719",
      "L 292.1227722167969 323.9653625488281",
      "L 294.4179382324219 325.0533447265625",
      "L 296.8981018066406 327.4375305175781",
      "L 299.7431335449219 329.9058837890625",
      "L 301.6486511230469 332.9527587890625",
      "L 303.7219543457031 335.3371276855469",
      "L 305.62567138671875 338.3368225097656",
      "L 307.55352783203125 342.3602600097656",
      "L 307.2616271972656 343.3841857910156",
      "L 308.3522644042969 346.66143798828125",
      "L 309.4429016113281 348.9577941894531",
      "L 309.4429016113281 352.5234375",
      "L 309.4429016113281 356.2855224609375",
      "L 309.4429016113281 359.16192626953125",
      "L 309.4429016113281 363.18780517578125",
      "L 309.4429016113281 366.1899719238281",
      "L 308.0421142578125 371.56396484375",
      "L 306.1549987792969 374.9066467285156",
      "L 304.1872253417969 379.01300048828125",
      "L 301.9443664550781 383.5713806152344",
      "L 300.6648864746094 385.98828125",
      "L 297.33563232421875 390.0042724609375",
      "L 293.1928405761719 395.2073059082031",
      "L 288.73028564453125 399.4233703613281",
      "L 284.8171691894531 404.14276123046875",
      "L 282.5943298339844 407.3833312988281",
      "L 277.825927734375 411.7760009765625",
      "L 272.3490905761719 416.0609130859375",
      "L 265.2539367675781 422.69091796875",
      "L 260.2485046386719 425.3122253417969",
      "L 254.27293395996094 429.32293701171875",
      "L 249.86190795898438 431.9178771972656",
      "L 246.38809204101562 434.1549072265625",
      "L 243.99169921875 435.2435607910156",
      "L 240.836181640625 436.5740966796875",
      "L 238.34474182128906 437.4188537597656",
      "L 236.71742248535156 438.20703125",
      "L 235.08145141601562 438.5068359375",
      "L 233.20526123046875 438.5068359375",
      "L 232.17027282714844 438.5068359375",
      "L 231.39614868164062 438.5068359375",
      "L 229.6776885986328 438.5068359375",
      "L 228.36578369140625 438.5068359375",
      "L 226.96929931640625 438.5068359375",
      "L 224.5851593017578 438.5068359375",
      "L 223.07870483398438 438.5068359375",
      "L 221.1538543701172 437.4188537597656",
      "L 218.72142028808594 437.4188537597656",
      "L 217.36871337890625 435.2428894042969",
      "L 214.94163513183594 434.5625305175781",
      "L 212.54843139648438 434.1549072265625",
      "L 211.6206512451172 432.2911071777344",
      "L 209.43936157226562 432.0209045410156",
      "L 207.80340576171875 431.2452087402344",
      "L 207.25807189941406 430.4799499511719",
      "L 205.6221160888672 430.1572265625",
      "L 204.61981201171875 430.1572265625",
      "L 203.98614501953125 428.6629638671875",
      "L 202.35018920898438 427.98126220703125",
      "L 202.3288116455078 426.86798095703125",
      "L 201.0571746826172 425.7634582519531",
      "L 199.98313903808594 425.5871276855469",
      "L 199.1775360107422 424.1500244140625",
      "L 198.89248657226562 423.03985595703125",
      "L 197.88243103027344 422.87030029296875",
      "L 197.80184936523438 421.2383117675781",
      "L 196.29595947265625 420.6943359375",
      "L 195.6205596923828 418.9421081542969",
      "L 195.6205596923828 417.9743957519531",
      "L 194.52992248535156 417.4303894042969",
      "L 194.52992248535156 416.3424072265625",
      "L 193.43927001953125 414.5702209472656",
      "L 193.43927001953125 414.15380859375",
      "L 192.71478271484375 413.4327087402344",
      "L 192.3486328125 412.5689392089844",
      "L 191.70643615722656 412.3447265625",
      "L 191.62953186035156 411.2032165527344",
      "L 191.62953186035156 409.5994873046875",
      "L 190.71022033691406 408.1384582519531",
      "L 189.99356079101562 407.42352294921875",
      "L 190.53887939453125 405.5870361328125",
      "L 190.53887939453125 405.05780029296875",
      "L 189.4482421875 403.9698181152344",
      "L 189.4482421875 401.2498779296875",
      "L 189.4482421875 400.70587158203125",
      "L 188.35760498046875 399.98583984375",
      "L 188.35760498046875 399.07391357421875",
      "L 187.26695251464844 398.7442321777344",
      "L 187.26695251464844 396.8726501464844",
      "L 187.26695251464844 396.3286437988281",
    ],
  };

  const [paths, setPaths] = useState<IPath | null>(null);
  const navigation = useNavigation();
  const accuracyCheck = (pathToCheck: IPath, threshold: number) => {
    let path1: { x: number; y: number }[] = [];
    let path2: { x: number; y: number }[] = [];
    placeHolderPath.segments.forEach((element, i) => {
      const Y1 = parseFloat(element?.split(" ")[1]);
      const X1 = parseFloat(element?.split(" ")[2]);
      path1.push({ x: X1, y: Y1 });
      const Y2 = parseFloat(pathToCheck.segments[i]?.split(" ")[1]);
      const X2 = parseFloat(pathToCheck.segments[i]?.split(" ")[2]);
      path2.push({ x: X2, y: Y2 });
    });

    const diferencePath = (p1, p2) => {
      [p1, p2].forEach(function (p) {
        p.sort(function (a, b) {
          return a.x < b.x || (a.x == b.x && a.y < b.y) ? -1 : 1;
        });
      });

      return p1.map(function (p, i) {
        return { dx: Math.abs(p2[i].x - p.x), dy: Math.abs(p2[i].y - p.y) };
      });
    };

    const averageXdiference =
      diferencePath(path1, path2).reduce((a, b) => a + b.dx, 0) /
      diferencePath(path1, path2).length;

    const averageYdiference =
      diferencePath(path1, path2).reduce((a, b) => a + b.dy, 0) /
      diferencePath(path1, path2).length;

    return averageXdiference < threshold && averageYdiference < threshold;
  };

  const reset = () => {
    setPaths(null);
  };

  const onEndHandler = () => {
    const onSuccess = () => {
      Toast.show({
        type: "success",
        text1: "Hooray !",
        visibilityTime: 1000,
      });
      navigation.navigate("Content"), reset();
    };
    const onError = () => {
      Toast.show({
        type: "error",
        text1: "Try again !",
        visibilityTime: 1000,
      });
      reset();
    };

    accuracyCheck(paths, 4000000) ? onSuccess() : onError();
  };

  const pan = Gesture.Pan()
    .onStart((g) => {
      const newPaths = {
        segments: [],
        color: palette.light,
      };

      newPaths.segments.push(`M ${g.x} ${g.y}`);
      setPaths(newPaths);
    })
    .onUpdate((g) => {
      const newPaths = { ...paths };
      if (newPaths?.segments) {
        newPaths.segments.push(`L ${g.x} ${g.y}`);
        setPaths(newPaths);
      }
    })
    .minDistance(1)
    .onEnd(onEndHandler);

  return (
    <View style={stylesWithPalette.container}>
      <GestureHandlerRootView style={{ flex: 1 }}>
        <GestureDetector gesture={pan}>
          <Canvas style={{ flex: 1 }}>
            <Path
              path={placeHolderPath.segments.join(" ")}
              strokeWidth={20}
              style="stroke"
              color={placeHolderPath.color}
            />

            {paths && (
              <Path
                path={paths.segments.join(" ")}
                strokeWidth={20}
                style="stroke"
                color={paths.color}
              />
            )}
          </Canvas>
        </GestureDetector>
      </GestureHandlerRootView>
    </View>
  );
}

const styles = (palette) =>
  StyleSheet.create({
    container: {
      flex: 1,
      backgroundColor: palette.dark,
      borderRadius: 16,
    },
  });
